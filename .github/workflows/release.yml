name: Release Edge Extension

on:
  push:
    tags:
      - 'v*'  # è§¸ç™¼æ¢ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ¨™ç±¤ (ä¾‹å¦‚ v1.0.0)
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 1.0.1)'
        required: true
        type: string
      release_notes:
        description: 'ç™¼å¸ƒèªªæ˜'
        required: false
        type: string
        default: 'æ–°ç‰ˆæœ¬ç™¼å¸ƒ'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Get version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        
    - name: Update manifest version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        # æ›´æ–° manifest.json ä¸­çš„ç‰ˆæœ¬è™Ÿ
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" manifest.json
        echo "Updated manifest.json version to $VERSION"
        
    - name: Generate icons (if needed)
      run: |
        # æª¢æŸ¥æ˜¯å¦å­˜åœ¨åœ–ç¤ºæª”æ¡ˆï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å»ºç«‹é è¨­åœ–ç¤º
        mkdir -p icons
        if [ ! -f "icons/icon16.png" ]; then
          echo "Creating default icons..."
          # å»ºç«‹ç°¡å–®çš„ SVG åœ–ç¤ºä¸¦è½‰æ›ç‚º PNG
          cat > icons/icon.svg << 'EOF'
        <svg width="128" height="128" xmlns="http://www.w3.org/2000/svg">
          <rect width="128" height="128" fill="#2563eb" rx="16"/>
          <text x="64" y="75" font-family="Arial, sans-serif" font-size="48" fill="white" text-anchor="middle" font-weight="bold">æŠ€</text>
        </svg>
        EOF
          
          # å¦‚æœç³»çµ±æœ‰ convert å‘½ä»¤ï¼ˆImageMagickï¼‰ï¼Œå‰‡è½‰æ› SVG ç‚º PNG
          if command -v convert &> /dev/null; then
            convert icons/icon.svg -resize 16x16 icons/icon16.png
            convert icons/icon.svg -resize 32x32 icons/icon32.png
            convert icons/icon.svg -resize 48x48 icons/icon48.png
            convert icons/icon.svg -resize 128x128 icons/icon128.png
            echo "Generated PNG icons from SVG"
          else
            echo "ImageMagick not available, skipping icon generation"
          fi
        fi
        
    - name: Create extension package
      run: |
        # å»ºç«‹ç™¼å¸ƒç›®éŒ„
        mkdir -p release
        
        # è¤‡è£½å¿…è¦æª”æ¡ˆåˆ°ç™¼å¸ƒç›®éŒ„
        cp manifest.json release/
        cp popup.html release/
        cp background.js release/
        cp -r scripts release/
        cp -r styles release/
        
        # è¤‡è£½åœ–ç¤ºæª”æ¡ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "icons" ] && [ "$(ls -A icons/*.png 2>/dev/null)" ]; then
          cp -r icons release/
          echo "Copied icon files"
        fi
        
        # å»ºç«‹ ZIP æª”æ¡ˆ
        cd release
        zip -r "../gigabyte-attendance-tracker-v${{ steps.version.outputs.version }}.zip" .
        cd ..
        
        echo "Created extension package: gigabyte-attendance-tracker-v${{ steps.version.outputs.version }}.zip"
        
    - name: Generate release notes
      id: release_notes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          NOTES="${{ github.event.inputs.release_notes }}"
        else
          # å¾ git log ç”Ÿæˆç™¼å¸ƒèªªæ˜
          NOTES=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD 2>/dev/null || echo "- æ–°ç‰ˆæœ¬ç™¼å¸ƒ")
        fi
        
        # å»ºç«‹å®Œæ•´çš„ç™¼å¸ƒèªªæ˜
        cat > release_notes.md << EOF
        ## ğŸš€ æŠ€å˜‰å‡ºå‹¤æ™‚é–“è¿½è¹¤å™¨ v${{ steps.version.outputs.version }}
        
        ### ğŸ“¥ å®‰è£æ–¹æ³•
        
        1. ä¸‹è¼‰ä¸‹æ–¹çš„ \`gigabyte-attendance-tracker-v${{ steps.version.outputs.version }}.zip\` æª”æ¡ˆ
        2. è§£å£“ç¸®åˆ°æœ¬æ©Ÿè³‡æ–™å¤¾
        3. é–‹å•Ÿ Microsoft Edgeï¼Œå‰å¾€ \`edge://extensions/\`
        4. é–‹å•Ÿã€Œé–‹ç™¼äººå“¡æ¨¡å¼ã€
        5. é»æ“Šã€Œè¼‰å…¥è§£å£“ç¸®ã€ä¸¦é¸æ“‡è§£å£“ç¸®çš„è³‡æ–™å¤¾
        6. é–‹å§‹ä½¿ç”¨ï¼
        
        ### ğŸ“‹ ç³»çµ±éœ€æ±‚
        
        - Microsoft Edge ç€è¦½å™¨ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
        - æŠ€å˜‰ EIP ç³»çµ±æœ‰æ•ˆå¸³è™Ÿ
        - å¸³è™Ÿæ ¼å¼ï¼š\`gigabyte\\your.username\`
        
        ### ğŸ”„ æ›´æ–°èªªæ˜
        
        $NOTES
        
        ### ğŸ“š ä½¿ç”¨èªªæ˜
        
        è©³ç´°ä½¿ç”¨èªªæ˜è«‹åƒè€ƒï¼š[ä½¿ç”¨æ–‡ä»¶](https://edge.jakeuj.com)
        
        ### ğŸ› å•é¡Œå›å ±
        
        å¦‚æœ‰å•é¡Œè«‹è‡³ [Issues](https://github.com/jakeuj/edge-extension/issues) å›å ±
        EOF
        
        echo "Generated release notes"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "æŠ€å˜‰å‡ºå‹¤æ™‚é–“è¿½è¹¤å™¨ v${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        files: |
          gigabyte-attendance-tracker-v${{ steps.version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update version and download links in index.html
      run: |
        # æ›´æ–° index.html ä¸­çš„ç‰ˆæœ¬è™Ÿå’Œä¸‹è¼‰é€£çµ
        VERSION="${{ steps.version.outputs.version }}"
        DOWNLOAD_URL="https://github.com/jakeuj/edge-extension/releases/download/v${VERSION}/gigabyte-attendance-tracker-v${VERSION}.zip"

        # æ›´æ–°ç‰ˆæœ¬è™Ÿé¡¯ç¤º
        sed -i "s|<strong>v[0-9]\+\.[0-9]\+\.[0-9]\+</strong>|<strong>v${VERSION}</strong>|g" index.html

        # æ›´æ–°ä¸‹è¼‰é€£çµï¼ˆåŒ¹é…å¯¦éš›çš„ä¸‹è¼‰ URL æ¨¡å¼ï¼‰
        sed -i "s|https://github.com/jakeuj/edge-extension/releases/download/v[0-9]\+\.[0-9]\+\.[0-9]\+/gigabyte-attendance-tracker-v[0-9]\+\.[0-9]\+\.[0-9]\+\.zip|${DOWNLOAD_URL}|g" index.html

        echo "Updated version to v${VERSION} and download links in index.html"
        
    - name: Commit updated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add manifest.json index.html
        git commit -m "chore: update version to v${{ steps.version.outputs.version }} and download link" || exit 0
        git push origin HEAD:main || echo "No changes to push"
        
    - name: Summary
      run: |
        echo "âœ… ç™¼å¸ƒå®Œæˆï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬ï¼šv${{ steps.version.outputs.version }}"
        echo "ğŸ”— ä¸‹è¼‰é€£çµï¼šhttps://github.com/jakeuj/edge-extension/releases/tag/v${{ steps.version.outputs.version }}"
        echo "ğŸ“„ ç™¼å¸ƒé é¢ï¼šhttps://github.com/jakeuj/edge-extension/releases"
