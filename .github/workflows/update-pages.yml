name: Update GitHub Pages

on:
  release:
    types: [published]  # ç•¶æ–° release ç™¼å¸ƒæ™‚è§¸ç™¼
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-pages:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Get latest release info
      id: release
      run: |
        # ç²å–æœ€æ–° release è³‡è¨Š
        LATEST_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest")
        VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name' | sed 's/^v//')
        DOWNLOAD_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[0].browser_download_url')
        RELEASE_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url')
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
        echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
        
        echo "Latest version: $VERSION"
        echo "Download URL: $DOWNLOAD_URL"
        
    - name: Update index.html with latest release info
      run: |
        VERSION="${{ steps.release.outputs.version }}"
        DOWNLOAD_URL="${{ steps.release.outputs.download_url }}"
        RELEASE_URL="${{ steps.release.outputs.release_url }}"
        
        # æ›´æ–°ç‰ˆæœ¬è™Ÿ
        sed -i "s/version \"[^\"]*\"/version \"$VERSION\"/g" index.html
        
        # æ›´æ–°ä¸‹è¼‰é€£çµ
        sed -i "s|href=\"https://github.com/jakeuj/edge-extension/releases[^\"]*\"|href=\"$DOWNLOAD_URL\"|g" index.html
        
        # æ›´æ–° "æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬" é€£çµ
        if ! grep -q "æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬" index.html; then
          # å¦‚æœæ²’æœ‰ "æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬" é€£çµï¼Œåœ¨ä¸‹è¼‰æŒ‰éˆ•å¾Œæ·»åŠ 
          sed -i "s|</a>|</a>\n            <a href=\"$RELEASE_URL\" class=\"version-link\" target=\"_blank\">ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬</a>|g" index.html
        else
          sed -i "s|href=\"[^\"]*\" class=\"version-link\"|href=\"$RELEASE_URL\" class=\"version-link\"|g" index.html
        fi
        
        echo "Updated index.html with version $VERSION"
        
    - name: Add version info and update timestamp
      run: |
        # æ·»åŠ æ›´æ–°æ™‚é–“æˆ³
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        # åœ¨ index.html ä¸­æ·»åŠ æˆ–æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
        if grep -q "æœ€å¾Œæ›´æ–°" index.html; then
          sed -i "s/æœ€å¾Œæ›´æ–°ï¼š[^<]*/æœ€å¾Œæ›´æ–°ï¼š$TIMESTAMP/g" index.html
        else
          # å¦‚æœæ²’æœ‰æ›´æ–°æ™‚é–“ï¼Œåœ¨é é¢åº•éƒ¨æ·»åŠ 
          sed -i "s|</body>|    <div class=\"update-info\">æœ€å¾Œæ›´æ–°ï¼š$TIMESTAMP</div>\n</body>|g" index.html
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add index.html
          git commit -m "docs: update GitHub Pages with latest release v${{ steps.release.outputs.version }}"
          git push origin main
          echo "Pushed changes to main branch"
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        publish_branch: gh-pages
        exclude_assets: |
          .github
          .gitignore
          *.md
          test/
          tools/
          scripts/
          styles/
          background.js
          popup.html
          manifest.json
          *.json
          *.http
        
    - name: Summary
      run: |
        echo "âœ… GitHub Pages æ›´æ–°å®Œæˆï¼"
        echo "ğŸŒ ç¶²ç«™ï¼šhttps://edge.jakeuj.com"
        echo "ğŸ“¦ æœ€æ–°ç‰ˆæœ¬ï¼šv${{ steps.release.outputs.version }}"
        echo "ğŸ”— ä¸‹è¼‰é€£çµå·²æ›´æ–°"
