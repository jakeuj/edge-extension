# 自動重新登入功能說明

## 功能概述

已實現 Token 過期時自動重新登入的功能，取代原本的自動登出機制。

## 主要變更

### 1. 新增加密模組 (`scripts/crypto.js`)

- 使用 Web Crypto API 實現 AES-GCM 加密
- 基於瀏覽器指紋生成加密金鑰
- 提供安全的密碼儲存和讀取功能

**主要方法：**
- `encrypt(plaintext)` - 加密文字
- `decrypt(encryptedBase64)` - 解密文字
- `saveCredentials(account, password)` - 儲存加密的憑證
- `loadCredentials()` - 讀取並解密憑證
- `clearCredentials()` - 清除儲存的憑證
- `hasStoredCredentials()` - 檢查是否有儲存的憑證

### 2. 修改認證模組 (`scripts/auth.js`)

**新增方法：**
- `attemptAutoRelogin()` - 嘗試使用儲存的憑證自動重新登入
- `handleApiError(error)` - 處理 API 錯誤並自動重新登入

**修改方法：**
- `init()` - 初始化時檢查 token 是否過期，過期則自動重新登入
- `login()` - 登入時如果勾選「記住登入資訊」，會加密並儲存密碼
- `logout(clearCredentials)` - 登出時可選擇是否清除儲存的憑證

### 3. 修改背景腳本 (`background.js`)

**變更：**
- 移除原本的 8 小時自動登出機制
- 新增定期檢查機制：每小時檢查一次，如果超過 7.5 小時則預先重新登入
- 登入時儲存加密後的密碼（如果勾選記住）
- 登出時保留憑證以便自動重新登入

**新增函數：**
- `attemptAutoRelogin()` - 背景腳本的自動重新登入函數

### 4. 修改 Popup 介面 (`scripts/popup.js`)

**變更：**
- 等待模組載入時包含 `cryptoManager`
- 初始化時自動初始化加密管理器
- API 錯誤處理改為嘗試自動重新登入，成功後重試操作
- 自動重新登入失敗才顯示登入畫面

### 5. 更新 HTML (`popup.html`)

**變更：**
- 加入 `scripts/crypto.js` 的引用

## 工作流程

### 登入流程

1. 使用者輸入帳號密碼並勾選「記住登入資訊」
2. 密碼被加密（使用 AES-GCM）
3. 加密後的密碼和帳號儲存到 Chrome Storage
4. 登入成功，記錄登入時間

### 自動重新登入流程

#### 情境 A：定期檢查觸發

1. 背景腳本每小時檢查一次登入時間
2. 如果超過 7.5 小時（接近 8 小時過期時間）
3. 自動讀取儲存的憑證
4. 解密密碼
5. 使用憑證重新登入
6. 更新 serverKey 和登入時間

#### 情境 B：API 錯誤觸發

1. 使用者操作時 API 回傳 401 認證錯誤
2. `authManager.handleApiError()` 偵測到認證錯誤
3. 自動嘗試重新登入
4. 如果成功，重試原本的操作
5. 如果失敗，顯示登入畫面

#### 情境 C：初始化時觸發

1. 開啟 Popup 時初始化認證管理器
2. 檢查登入時間是否超過 8 小時
3. 如果過期，自動嘗試重新登入
4. 成功則直接顯示出勤資料
5. 失敗則顯示登入畫面

### 登出流程

1. 使用者點擊登出按鈕
2. 清除登入狀態（isLoggedIn, serverKey）
3. **保留**儲存的憑證（savedAccount, savedPassword, hasCredentials）
4. 下次 token 過期時可以自動重新登入

## 安全性考量

### 加密機制

- 使用 AES-GCM 256-bit 加密
- 使用 PBKDF2 進行金鑰派生（100,000 次迭代）
- 每次加密使用隨機 salt 和 IV
- 金鑰基於瀏覽器指紋，無法跨裝置使用

### 儲存位置

- 密碼儲存在 Chrome Storage Local
- 只能在同一瀏覽器的同一擴充套件中存取
- 無法從外部直接讀取

### 限制

- 加密金鑰基於瀏覽器環境，重新安裝擴充套件後無法解密
- 不建議在共用電腦上使用「記住登入資訊」功能
- 如果需要完全清除憑證，需要手動清除擴充套件資料

## 使用方式

### 啟用自動重新登入

1. 登入時勾選「記住登入資訊」
2. 系統會自動加密並儲存密碼
3. Token 過期時會自動重新登入

### 停用自動重新登入

方法 1：登入時不勾選「記住登入資訊」
方法 2：清除瀏覽器擴充套件資料

## 測試建議

### 測試案例 1：正常自動重新登入

1. 登入並勾選「記住登入資訊」
2. 手動修改 `lastLoginTime` 為 8 小時前
3. 重新開啟 Popup
4. 應該自動重新登入並顯示出勤資料

### 測試案例 2：API 錯誤自動重新登入

1. 登入並勾選「記住登入資訊」
2. 手動清除 `serverKey`
3. 嘗試重新整理出勤資料
4. 應該自動重新登入並重試操作

### 測試案例 3：無儲存憑證

1. 登入但不勾選「記住登入資訊」
2. 手動修改 `lastLoginTime` 為 8 小時前
3. 重新開啟 Popup
4. 應該顯示登入畫面

### 測試案例 4：定期檢查

1. 登入並勾選「記住登入資訊」
2. 等待 7.5 小時（或手動觸發背景腳本的檢查）
3. 應該自動重新登入
4. 檢查 `lastLoginTime` 是否更新

## 除錯資訊

所有自動重新登入的操作都會在 Console 中記錄：

- `嘗試自動重新登入...` - 開始嘗試
- `自動重新登入成功` - 成功
- `自動重新登入失敗: [錯誤訊息]` - 失敗
- `無法讀取儲存的憑證: [錯誤訊息]` - 無憑證或解密失敗

## 已知限制

1. 密碼加密基於瀏覽器環境，無法跨裝置同步
2. 重新安裝擴充套件後需要重新登入
3. 如果伺服器端的認證機制改變，可能需要手動重新登入
4. 背景腳本的定期檢查間隔為 1 小時，可能不夠即時

## 未來改進方向

1. 加入使用者設定選項，讓使用者選擇是否啟用自動重新登入
2. 提供手動清除憑證的按鈕
3. 加入憑證過期時間設定
4. 改善背景腳本的檢查機制，更即時地偵測 token 過期
5. 加入生物辨識（如果瀏覽器支援）作為額外的安全層

