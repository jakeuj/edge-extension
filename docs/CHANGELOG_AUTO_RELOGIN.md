# è‡ªå‹•é‡æ–°ç™»å…¥åŠŸèƒ½ - è®Šæ›´æ—¥èªŒ

## ç‰ˆæœ¬ï¼š1.1.0
## æ—¥æœŸï¼š2025-10-03

---

## ğŸ“‹ è®Šæ›´æ‘˜è¦

å–æ¶ˆåŸæœ¬çš„ 8 å°æ™‚è‡ªå‹•ç™»å‡ºæ©Ÿåˆ¶ï¼Œæ”¹ç‚º **Token éæœŸæ™‚è‡ªå‹•é‡æ–°ç™»å…¥**ã€‚

### ä¸»è¦å„ªé»

âœ… **ç„¡ç¸«é«”é©—** - ä½¿ç”¨è€…ä¸æœƒå› ç‚º token éæœŸè€Œè¢«å¼·åˆ¶ç™»å‡º  
âœ… **è‡ªå‹•æ¢å¾©** - API éŒ¯èª¤æ™‚è‡ªå‹•å˜—è©¦é‡æ–°ç™»å…¥ä¸¦é‡è©¦æ“ä½œ  
âœ… **å®‰å…¨å„²å­˜** - ä½¿ç”¨ AES-GCM 256-bit åŠ å¯†å„²å­˜å¯†ç¢¼  
âœ… **é é˜²æ€§æ›´æ–°** - åœ¨ token éæœŸå‰è‡ªå‹•æ›´æ–°ï¼ˆ7.5 å°æ™‚ï¼‰  

---

## ğŸ“ æ–°å¢æª”æ¡ˆ

### 1. `scripts/crypto.js`
åŠ å¯†å·¥å…·æ¨¡çµ„ï¼Œæä¾›å®‰å…¨çš„å¯†ç¢¼å„²å­˜åŠŸèƒ½ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- AES-GCM 256-bit åŠ å¯†
- PBKDF2 é‡‘é‘°æ´¾ç”Ÿï¼ˆ100,000 æ¬¡è¿­ä»£ï¼‰
- åŸºæ–¼ç€è¦½å™¨æŒ‡ç´‹çš„é‡‘é‘°ç”Ÿæˆ
- éš¨æ©Ÿ salt å’Œ IV ç¢ºä¿æ¯æ¬¡åŠ å¯†çµæœä¸åŒ

### 2. `AUTO_RELOGIN_FEATURE.md`
è©³ç´°çš„åŠŸèƒ½èªªæ˜æ–‡ä»¶ã€‚

### 3. `test-crypto.html`
åŠ å¯†åŠŸèƒ½æ¸¬è©¦é é¢ï¼Œå¯ç”¨æ–¼é©—è­‰åŠ å¯†/è§£å¯†åŠŸèƒ½ã€‚

### 4. `CHANGELOG_AUTO_RELOGIN.md`
æœ¬è®Šæ›´æ—¥èªŒã€‚

---

## ğŸ”§ ä¿®æ”¹æª”æ¡ˆ

### 1. `background.js`

#### è®Šæ›´å…§å®¹ï¼š
- âŒ ç§»é™¤ï¼š8 å°æ™‚è‡ªå‹•ç™»å‡ºæ©Ÿåˆ¶
- âœ… æ–°å¢ï¼š`attemptAutoRelogin()` å‡½æ•¸
- âœ… æ–°å¢ï¼šå®šæœŸæª¢æŸ¥æ©Ÿåˆ¶ï¼ˆæ¯å°æ™‚æª¢æŸ¥ï¼Œ7.5 å°æ™‚å¾Œé å…ˆé‡æ–°ç™»å…¥ï¼‰
- âœ… ä¿®æ”¹ï¼šç™»å…¥æ™‚å„²å­˜åŠ å¯†å¾Œçš„å¯†ç¢¼
- âœ… ä¿®æ”¹ï¼šç™»å‡ºæ™‚ä¿ç•™æ†‘è­‰

#### é—œéµç¨‹å¼ç¢¼ï¼š
```javascript
// è‡ªå‹•é‡æ–°ç™»å…¥æ©Ÿåˆ¶
async function attemptAutoRelogin() {
    // è®€å–å„²å­˜çš„æ†‘è­‰ä¸¦é‡æ–°ç™»å…¥
}

// å®šæœŸæª¢æŸ¥ï¼ˆæ¯å°æ™‚ï¼‰
setInterval(async () => {
    if (hoursSinceLogin > 7.5 && hasCredentials) {
        await attemptAutoRelogin();
    }
}, 60 * 60 * 1000);
```

---

### 2. `scripts/auth.js`

#### è®Šæ›´å…§å®¹ï¼š
- âœ… æ–°å¢ï¼š`attemptAutoRelogin()` - è‡ªå‹•é‡æ–°ç™»å…¥æ–¹æ³•
- âœ… æ–°å¢ï¼š`handleApiError(error)` - API éŒ¯èª¤è™•ç†
- âœ… ä¿®æ”¹ï¼š`init()` - åˆå§‹åŒ–æ™‚æª¢æŸ¥éæœŸä¸¦è‡ªå‹•é‡æ–°ç™»å…¥
- âœ… ä¿®æ”¹ï¼š`login()` - ç™»å…¥æ™‚åŠ å¯†ä¸¦å„²å­˜å¯†ç¢¼
- âœ… ä¿®æ”¹ï¼š`logout(clearCredentials)` - å¯é¸æ“‡æ˜¯å¦æ¸…é™¤æ†‘è­‰

#### é—œéµç¨‹å¼ç¢¼ï¼š
```javascript
// åˆå§‹åŒ–æ™‚è‡ªå‹•é‡æ–°ç™»å…¥
async init() {
    if (hoursSinceLogin > 8) {
        const reloginResult = await this.attemptAutoRelogin();
        if (!reloginResult.success) {
            await this.logout();
            return false;
        }
        return true;
    }
}

// ç™»å…¥æ™‚å„²å­˜åŠ å¯†å¯†ç¢¼
async login(account, password, remember = false) {
    if (remember && window.cryptoManager) {
        await window.cryptoManager.saveCredentials(account, password);
    }
}

// API éŒ¯èª¤è™•ç†
async handleApiError(error) {
    if (error.message.includes('401')) {
        const reloginResult = await this.attemptAutoRelogin();
        if (reloginResult.success) {
            return { success: true, shouldRetry: true };
        }
    }
}
```

---

### 3. `scripts/popup.js`

#### è®Šæ›´å…§å®¹ï¼š
- âœ… ä¿®æ”¹ï¼š`waitForModules()` - ç­‰å¾… cryptoManager è¼‰å…¥
- âœ… ä¿®æ”¹ï¼š`loadAttendanceData()` - API éŒ¯èª¤æ™‚è‡ªå‹•é‡æ–°ç™»å…¥ä¸¦é‡è©¦

#### é—œéµç¨‹å¼ç¢¼ï¼š
```javascript
// ç­‰å¾…æ¨¡çµ„è¼‰å…¥
async waitForModules() {
    while (...) {
        if (window.authManager && ... && window.cryptoManager) {
            await window.cryptoManager.init();
            return;
        }
    }
}

// API éŒ¯èª¤è™•ç†
catch (error) {
    if (error.message.includes('401')) {
        const reloginResult = await window.authManager.handleApiError(error);
        if (reloginResult.success && reloginResult.shouldRetry) {
            await this.loadAttendanceData(showLoading); // é‡è©¦
        }
    }
}
```

---

### 4. `popup.html`

#### è®Šæ›´å…§å®¹ï¼š
- âœ… æ–°å¢ï¼šå¼•ç”¨ `scripts/crypto.js`

#### è®Šæ›´ä½ç½®ï¼š
```html
<script src="scripts/crypto.js"></script>
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æµç¨‹åœ–

```
ä½¿ç”¨è€…ç™»å…¥ï¼ˆå‹¾é¸è¨˜ä½ï¼‰
    â†“
å¯†ç¢¼åŠ å¯†ä¸¦å„²å­˜
    â†“
æ­£å¸¸ä½¿ç”¨ï¼ˆ< 7.5 å°æ™‚ï¼‰
    â†“
èƒŒæ™¯æª¢æŸ¥è§¸ç™¼ï¼ˆ> 7.5 å°æ™‚ï¼‰
    â†“
è‡ªå‹•é‡æ–°ç™»å…¥
    â†“
æ›´æ–° token å’Œç™»å…¥æ™‚é–“
    â†“
ç¹¼çºŒæ­£å¸¸ä½¿ç”¨
```

### API éŒ¯èª¤è™•ç†æµç¨‹

```
API è«‹æ±‚
    â†“
å›å‚³ 401 éŒ¯èª¤
    â†“
åµæ¸¬èªè­‰éŒ¯èª¤
    â†“
è®€å–å„²å­˜çš„æ†‘è­‰
    â†“
è§£å¯†å¯†ç¢¼
    â†“
è‡ªå‹•é‡æ–°ç™»å…¥
    â†“
æˆåŠŸï¼Ÿ
â”œâ”€ æ˜¯ â†’ é‡è©¦åŸæ“ä½œ
â””â”€ å¦ â†’ é¡¯ç¤ºç™»å…¥ç•«é¢
```

---

## ğŸ”’ å®‰å…¨æ€§

### åŠ å¯†è¦æ ¼

| é …ç›® | è¦æ ¼ |
|------|------|
| åŠ å¯†æ¼”ç®—æ³• | AES-GCM |
| é‡‘é‘°é•·åº¦ | 256-bit |
| é‡‘é‘°æ´¾ç”Ÿ | PBKDF2 |
| è¿­ä»£æ¬¡æ•¸ | 100,000 |
| Salt é•·åº¦ | 128-bit (éš¨æ©Ÿ) |
| IV é•·åº¦ | 96-bit (éš¨æ©Ÿ) |

### å®‰å…¨ç‰¹æ€§

âœ… æ¯æ¬¡åŠ å¯†ä½¿ç”¨ä¸åŒçš„ salt å’Œ IV  
âœ… é‡‘é‘°åŸºæ–¼ç€è¦½å™¨æŒ‡ç´‹ï¼Œç„¡æ³•è·¨è£ç½®ä½¿ç”¨  
âœ… å„²å­˜åœ¨ Chrome Storage Localï¼Œå¤–éƒ¨ç„¡æ³•å­˜å–  
âœ… ä½¿ç”¨ Web Crypto APIï¼ˆç€è¦½å™¨åŸç”ŸåŠ å¯†ï¼‰  

### å®‰å…¨é™åˆ¶

âš ï¸ é‡æ–°å®‰è£æ“´å……å¥—ä»¶å¾Œç„¡æ³•è§£å¯†èˆŠå¯†ç¢¼  
âš ï¸ ä¸å»ºè­°åœ¨å…±ç”¨é›»è…¦ä¸Šä½¿ç”¨  
âš ï¸ ç„¡æ³•é˜²æ­¢æœ‰æ¬Šé™å­˜å– Chrome Storage çš„æƒ¡æ„ç¨‹å¼  

---

## ğŸ§ª æ¸¬è©¦

### æ¸¬è©¦æª”æ¡ˆ

é–‹å•Ÿ `test-crypto.html` é€²è¡ŒåŠ å¯†åŠŸèƒ½æ¸¬è©¦ï¼š

1. **åŸºæœ¬åŠ å¯†/è§£å¯†æ¸¬è©¦** - é©—è­‰åŠ å¯†å’Œè§£å¯†åŠŸèƒ½
2. **æ†‘è­‰å„²å­˜/è®€å–æ¸¬è©¦** - é©—è­‰æ†‘è­‰ç®¡ç†åŠŸèƒ½
3. **éš¨æ©Ÿæ€§æ¸¬è©¦** - é©—è­‰æ¯æ¬¡åŠ å¯†çµæœä¸åŒ
4. **æ•ˆèƒ½æ¸¬è©¦** - æ¸¬è©¦ 100 æ¬¡åŠ å¯†/è§£å¯†çš„é€Ÿåº¦

### æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ

#### æ¸¬è©¦ 1ï¼šæ­£å¸¸è‡ªå‹•é‡æ–°ç™»å…¥
1. ç™»å…¥ä¸¦å‹¾é¸ã€Œè¨˜ä½ç™»å…¥è³‡è¨Šã€
2. é–‹å•Ÿ DevTools â†’ Application â†’ Storage â†’ Local Storage
3. ä¿®æ”¹ `lastLoginTime` ç‚º 8 å°æ™‚å‰çš„æ™‚é–“æˆ³
4. é—œé–‰ä¸¦é‡æ–°é–‹å•Ÿ Popup
5. **é æœŸçµæœ**ï¼šè‡ªå‹•é‡æ–°ç™»å…¥ä¸¦é¡¯ç¤ºå‡ºå‹¤è³‡æ–™

#### æ¸¬è©¦ 2ï¼šAPI éŒ¯èª¤è‡ªå‹•é‡æ–°ç™»å…¥
1. ç™»å…¥ä¸¦å‹¾é¸ã€Œè¨˜ä½ç™»å…¥è³‡è¨Šã€
2. é–‹å•Ÿ DevTools â†’ Application â†’ Storage â†’ Local Storage
3. åˆªé™¤ `serverKey`
4. é»æ“Šã€Œé‡æ–°æ•´ç†ã€æŒ‰éˆ•
5. **é æœŸçµæœ**ï¼šè‡ªå‹•é‡æ–°ç™»å…¥ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™

#### æ¸¬è©¦ 3ï¼šç„¡æ†‘è­‰æƒ…æ³
1. ç™»å…¥ä½†**ä¸å‹¾é¸**ã€Œè¨˜ä½ç™»å…¥è³‡è¨Šã€
2. ä¿®æ”¹ `lastLoginTime` ç‚º 8 å°æ™‚å‰
3. é‡æ–°é–‹å•Ÿ Popup
4. **é æœŸçµæœ**ï¼šé¡¯ç¤ºç™»å…¥ç•«é¢

---

## ğŸ“Š æ•ˆèƒ½å½±éŸ¿

### åŠ å¯†æ•ˆèƒ½

- **åŠ å¯†æ™‚é–“**ï¼šç´„ 10-20 ms/æ¬¡
- **è§£å¯†æ™‚é–“**ï¼šç´„ 10-20 ms/æ¬¡
- **åˆå§‹åŒ–æ™‚é–“**ï¼šç´„ 50-100 ms

### å„²å­˜ç©ºé–“

- **åŠ å¯†å¾Œå¯†ç¢¼å¤§å°**ï¼šç´„ 100-150 bytesï¼ˆBase64 ç·¨ç¢¼ï¼‰
- **ç¸½å¢åŠ ç©ºé–“**ï¼š< 1 KB

### èƒŒæ™¯è…³æœ¬

- **æª¢æŸ¥é »ç‡**ï¼šæ¯å°æ™‚ä¸€æ¬¡
- **CPU ä½¿ç”¨**ï¼šå¯å¿½ç•¥ä¸è¨ˆ

---

## ğŸ› å·²çŸ¥å•é¡Œ

1. **é‡æ–°å®‰è£æ“´å……å¥—ä»¶**ï¼šéœ€è¦é‡æ–°ç™»å…¥ï¼ˆåŠ å¯†é‡‘é‘°éºå¤±ï¼‰
2. **è·¨è£ç½®åŒæ­¥**ï¼šç„¡æ³•åŒæ­¥åŠ å¯†çš„å¯†ç¢¼
3. **æª¢æŸ¥å»¶é²**ï¼šèƒŒæ™¯æª¢æŸ¥é–“éš” 1 å°æ™‚ï¼Œå¯èƒ½ä¸å¤ å³æ™‚

---

## ğŸš€ æœªä¾†æ”¹é€²

### çŸ­æœŸï¼ˆv1.2.0ï¼‰
- [ ] åŠ å…¥ä½¿ç”¨è€…è¨­å®šé¸é …ï¼ˆå•Ÿç”¨/åœç”¨è‡ªå‹•é‡æ–°ç™»å…¥ï¼‰
- [ ] æä¾›æ‰‹å‹•æ¸…é™¤æ†‘è­‰æŒ‰éˆ•
- [ ] æ”¹å–„éŒ¯èª¤è¨Šæ¯å’Œä½¿ç”¨è€…æç¤º

### ä¸­æœŸï¼ˆv1.3.0ï¼‰
- [ ] ç¸®çŸ­èƒŒæ™¯æª¢æŸ¥é–“éš”ï¼ˆæ”¹ç‚º 15 åˆ†é˜ï¼‰
- [ ] åŠ å…¥æ†‘è­‰éæœŸæ™‚é–“è¨­å®š
- [ ] é¡¯ç¤ºä¸Šæ¬¡è‡ªå‹•é‡æ–°ç™»å…¥æ™‚é–“

### é•·æœŸï¼ˆv2.0.0ï¼‰
- [ ] æ”¯æ´ç”Ÿç‰©è¾¨è­˜ï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
- [ ] åŠ å…¥å¤šå¸³è™Ÿç®¡ç†
- [ ] æ”¹å–„åŠ å¯†é‡‘é‘°ç®¡ç†

---

## ğŸ“ é–‹ç™¼è€…æ³¨æ„äº‹é …

### é™¤éŒ¯

æ‰€æœ‰è‡ªå‹•é‡æ–°ç™»å…¥æ“ä½œéƒ½æœƒåœ¨ Console è¨˜éŒ„ï¼š

```javascript
console.log('å˜—è©¦è‡ªå‹•é‡æ–°ç™»å…¥...');
console.log('è‡ªå‹•é‡æ–°ç™»å…¥æˆåŠŸ');
console.error('è‡ªå‹•é‡æ–°ç™»å…¥å¤±æ•—:', error);
```

### æ¸¬è©¦ç’°å¢ƒ

å»ºè­°åœ¨æ¸¬è©¦ç’°å¢ƒä¸­ï¼š
1. ç¸®çŸ­éæœŸæ™‚é–“ï¼ˆæ”¹ç‚º 1 åˆ†é˜ï¼‰
2. å¢åŠ  Console æ—¥èªŒ
3. ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ

### ç¨‹å¼ç¢¼å¯©æŸ¥é‡é»

- âœ… ç¢ºèªå¯†ç¢¼ä¸æœƒä»¥æ˜æ–‡è¨˜éŒ„åœ¨ Console
- âœ… ç¢ºèªéŒ¯èª¤è¨Šæ¯ä¸æœƒæ´©æ¼æ•æ„Ÿè³‡è¨Š
- âœ… ç¢ºèªåŠ å¯†é‡‘é‘°ä¸æœƒè¢«å„²å­˜
- âœ… ç¢ºèªè‡ªå‹•é‡æ–°ç™»å…¥ä¸æœƒé€ æˆç„¡é™è¿´åœˆ

---

## ğŸ“ æ”¯æ´

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯çµ¡é–‹ç™¼åœ˜éšŠã€‚

---

## âœ… æª¢æŸ¥æ¸…å–®

éƒ¨ç½²å‰è«‹ç¢ºèªï¼š

- [x] æ‰€æœ‰æ–°æª”æ¡ˆå·²åŠ å…¥ç‰ˆæœ¬æ§åˆ¶
- [x] æ‰€æœ‰ä¿®æ”¹çš„æª”æ¡ˆå·²æ¸¬è©¦
- [x] åŠ å¯†åŠŸèƒ½æ¸¬è©¦é€šé
- [x] æ‰‹å‹•æ¸¬è©¦æ¡ˆä¾‹å…¨éƒ¨é€šé
- [x] Console ç„¡éŒ¯èª¤è¨Šæ¯
- [x] æ–‡ä»¶å·²æ›´æ–°
- [x] ç‰ˆæœ¬è™Ÿå·²æ›´æ–°

---

**è®Šæ›´å®Œæˆæ—¥æœŸ**ï¼š2025-10-03  
**é–‹ç™¼è€…**ï¼šAI Assistant  
**å¯©æŸ¥è€…**ï¼šå¾…å¯©æŸ¥  
**ç‹€æ…‹**ï¼šâœ… é–‹ç™¼å®Œæˆï¼Œå¾…æ¸¬è©¦

