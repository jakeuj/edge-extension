<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 設定測試</title>
    <link rel="stylesheet" href="popup.css">
    <style>
        body {
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        .current-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .current-settings pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #495057;
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 API 設定功能測試</h1>
        
        <div class="test-section">
            <h3>📋 當前設定</h3>
            <div class="current-settings">
                <pre id="currentSettings">載入中...</pre>
            </div>
            <button id="refreshSettings" class="btn btn-secondary">🔄 重新載入設定</button>
        </div>
        
        <div class="test-section">
            <h3>⚙️ API 設定測試</h3>
            
            <div class="input-group">
                <label for="testCompanyDomain">公司域名：</label>
                <input type="text" id="testCompanyDomain" placeholder="例如：gigabyte" value="gigabyte">
            </div>
            
            <div class="input-group">
                <label for="testLoginApiUrl">登入 API：</label>
                <input type="url" id="testLoginApiUrl" placeholder="https://your-api.com/login" value="https://hr.gigabyte.com/api/auth/login">
            </div>
            
            <div class="input-group">
                <label for="testAttendanceApiUrl">出勤查詢 API：</label>
                <input type="url" id="testAttendanceApiUrl" placeholder="https://your-api.com/attendance" value="https://hr.gigabyte.com/api/getAttendanceInfo">
            </div>
            
            <div class="input-group">
                <button id="saveTestSettings" class="btn btn-primary">💾 儲存測試設定</button>
                <button id="resetTestSettings" class="btn btn-secondary">🔄 重置為預設</button>
            </div>
            
            <div id="saveResult" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>👤 使用者名稱前綴測試</h3>
            
            <div class="input-group">
                <label for="testUsername">使用者名稱：</label>
                <div class="username-input">
                    <span id="testUsernamePrefix" class="username-prefix">company\</span>
                    <input type="text" id="testUsername" placeholder="username" value="test.user">
                </div>
            </div>
            
            <div class="input-group">
                <label>組合結果：</label>
                <div id="combinedAccount" style="font-family: monospace; font-weight: bold; color: #495057;">
                    company\test.user
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🧪 功能測試</h3>
            
            <div class="input-group">
                <button id="testLoadSettings" class="btn btn-primary">📥 測試載入設定</button>
                <button id="testSaveSettings" class="btn btn-primary">💾 測試儲存設定</button>
                <button id="testResetSettings" class="btn btn-secondary">🔄 測試重置設定</button>
            </div>
            
            <div id="testResults" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>📱 擴充套件整合測試</h3>
            <p>在 Microsoft Edge 中載入此擴充套件，然後測試以下功能：</p>
            <ul>
                <li>✅ API 設定按鈕顯示/隱藏</li>
                <li>✅ 公司域名即時更新前綴</li>
                <li>✅ 設定儲存和載入</li>
                <li>✅ 重置為預設值</li>
                <li>✅ 登入時使用自訂域名</li>
            </ul>
        </div>
    </div>

    <script>
        // 模擬 API 設定功能
        const DEFAULT_API_SETTINGS = {
            companyDomain: 'company',
            loginApiUrl: 'https://your-company-api.com/api/auth/login',
            attendanceApiUrl: 'https://your-company-api.com/api/getAttendanceInfo'
        };

        let apiSettings = { ...DEFAULT_API_SETTINGS };

        // 模擬儲存函數
        function setStorage(data) {
            return new Promise((resolve) => {
                Object.keys(data).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(data[key]));
                });
                resolve();
            });
        }

        function getStorage(key) {
            return new Promise((resolve) => {
                const value = localStorage.getItem(key);
                resolve(value ? JSON.parse(value) : null);
            });
        }

        // 載入設定
        async function loadApiSettings() {
            try {
                const saved = await getStorage('apiSettings');
                if (saved) {
                    apiSettings = { ...DEFAULT_API_SETTINGS, ...saved };
                }
                updateUI();
                showResult('testResults', '✅ 設定載入成功', 'success');
            } catch (error) {
                showResult('testResults', '❌ 載入失敗：' + error.message, 'error');
            }
        }

        // 儲存設定
        async function saveApiSettings() {
            try {
                apiSettings.companyDomain = document.getElementById('testCompanyDomain').value.trim() || 'company';
                apiSettings.loginApiUrl = document.getElementById('testLoginApiUrl').value.trim() || DEFAULT_API_SETTINGS.loginApiUrl;
                apiSettings.attendanceApiUrl = document.getElementById('testAttendanceApiUrl').value.trim() || DEFAULT_API_SETTINGS.attendanceApiUrl;
                
                await setStorage({ apiSettings });
                updateUI();
                showResult('saveResult', '✅ 設定已儲存', 'success');
                showResult('testResults', '✅ 設定儲存成功', 'success');
            } catch (error) {
                showResult('saveResult', '❌ 儲存失敗：' + error.message, 'error');
                showResult('testResults', '❌ 儲存失敗：' + error.message, 'error');
            }
        }

        // 重置設定
        function resetApiSettings() {
            apiSettings = { ...DEFAULT_API_SETTINGS };
            updateUI();
            showResult('saveResult', '🔄 已重置為預設設定', 'success');
            showResult('testResults', '🔄 重置成功', 'success');
        }

        // 更新 UI
        function updateUI() {
            document.getElementById('testCompanyDomain').value = apiSettings.companyDomain;
            document.getElementById('testLoginApiUrl').value = apiSettings.loginApiUrl;
            document.getElementById('testAttendanceApiUrl').value = apiSettings.attendanceApiUrl;
            
            // 更新前綴
            document.getElementById('testUsernamePrefix').textContent = `${apiSettings.companyDomain}\\`;
            
            // 更新組合結果
            const username = document.getElementById('testUsername').value;
            document.getElementById('combinedAccount').textContent = `${apiSettings.companyDomain}\\${username}`;
            
            // 更新當前設定顯示
            document.getElementById('currentSettings').textContent = JSON.stringify(apiSettings, null, 2);
        }

        // 顯示結果
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-result ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        // 事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            loadApiSettings();
            
            // 設定按鈕
            document.getElementById('saveTestSettings').addEventListener('click', saveApiSettings);
            document.getElementById('resetTestSettings').addEventListener('click', resetApiSettings);
            document.getElementById('refreshSettings').addEventListener('click', loadApiSettings);
            
            // 測試按鈕
            document.getElementById('testLoadSettings').addEventListener('click', loadApiSettings);
            document.getElementById('testSaveSettings').addEventListener('click', saveApiSettings);
            document.getElementById('testResetSettings').addEventListener('click', resetApiSettings);
            
            // 即時更新
            document.getElementById('testCompanyDomain').addEventListener('input', function() {
                const domain = this.value.trim() || 'company';
                document.getElementById('testUsernamePrefix').textContent = `${domain}\\`;
                
                const username = document.getElementById('testUsername').value;
                document.getElementById('combinedAccount').textContent = `${domain}\\${username}`;
            });
            
            document.getElementById('testUsername').addEventListener('input', function() {
                const domain = document.getElementById('testCompanyDomain').value.trim() || 'company';
                document.getElementById('combinedAccount').textContent = `${domain}\\${this.value}`;
            });
        });
    </script>
</body>
</html>
